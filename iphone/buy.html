<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>KLANmart - Buy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="../lib/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" href="../style/buy.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="../lib/jquery-1.11.1.min.js"></script>
    <script src="../lib/jquery.mobile-1.4.5.min.js"></script>
    <script src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons.js"></script>
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <script src="https://kit.fontawesome.com/2d990cff29.js" crossorigin="anonymous"></script>
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.0/aframe/build/aframe-ar.js"></script>


</head>

<body>

    <div data-role="header" data-position="fixed" class="header-bar">
        <i data-rel="back" class="fas fa-chevron-left back-icon"></i>
        <h1 class="page-detail">Order Information</h1>
    </div>

    <div data-role="content" data-theme="a">

        <div id="allContent" class="rwd-example prod-img-container">

            <div class="ui-block-a">
                <div id="customerDetails" class="ui-body ui-body-d">
                    <div id="leftThing">
                        <i class="glyphicon glyphicon-map-marker"></i>
                    </div>
                    <div id="content">
                        <ul data-role="listview">
                            <li>
                                <h6 id="custName">Kumar Sangakkara</h6>
                                <p id="custAddressRoad">51/5b, Kawdana road,</p>
                                <p id="custAddressCity">Dehiwala </p>
                                <p id="custAddressProvince">Western, LK </p>
                                <p id="custZipCode">10350. </p>
                                <p id="custMobileNumber">0770727311 </p>
                            </li>
                        </ul>
                    </div>
                    <div id="rightThing">
                        <a id="editAddress" href="#popupBasic" data-rel="popup" data-transition="pop">
                            <span class="glyphicon glyphicon-edit"></span>
                        </a>
                    </div>
                </div>
                <hr class="border">

            </div>

            <div id="productDetailss" class="ui-block-b" style="margin-top: 2%">
                <div class="ui-body ui-body-d">
                    <div id="prodNameH">
                        <div id="leftprodH">
                            <i class="glyphicon glyphicon-gift"></i>
                        </div>
                        <div id="prodHC">
                            <p id="productCategory" style="font-size: medium;font-weight: bold;">Men's cloths</p>
                        </div>
                    </div>
                    <hr class="border">
                    <div class="ui-grid-a" id="prodbody">
                        <div class="ui-body ui-body-d" id="prodBodyPic">
                            <img id="prodImg" style="width: 100%" src="../assets/images/products/tshirt1-blue.png" />
                        </div>
                        <div id="prodBodyCont">
                            <div class="ui-body ui-body-d">
                                <h6 id="prodName">2019 Spring Brand Clothing</h6>
                                <h5 id="prodPrice" style="font-weight: bold">LKR 2199.00</h5>
                                <h6 id="prodDelivery" style="color: #7285ff">Delivery charge: LKR 100.00</h6>
                            </div>
                        </div>
                    </div>
                    <hr class="border">
                    <div class="ui-grid-a">
                        <input type="text" name="textNote" id="txtNote" placeholder="Note to seller (optional)" value=""
                            data-corners="false" data-clear-btn="true">
                    </div>
                    <hr class="border">
                    <div id="prodTotal">
                        <div id="prodTotalleft" class="ui-body ui-body-d">
                            <h6 style="color: #5f6264">Sub Total :</h6>
                            <h6 style="color: #5f6264">Delivery Charge :</h6>
                            <h6 style="color: #010201">Total :</h6>

                        </div>
                        <div id="prodTotalright" class="ui-body ui-body-d">
                            <h6 id="calProdPrice" style="color: #5f6264;text-align: right">LKR 2199.00</h6>
                            <h6 id="calProdDel" style="color: #5f6264;text-align: right">LKR 100.00</h6>
                            <h6 id="calProdTotal" style="color: #010201;text-align: right">LKR 2299.00</h6>

                        </div>
                    </div>
                </div>
            </div>

            <div id="orderSummary" class="ui-block-c" style="margin-top: 2%" data-role="content" data-theme="a">
                <p style="font-size: medium;font-weight: bold;margin-left: 5%">Order Summary (1 item)</p>
                <hr class="border">
                <div id="sumTotal">
                    <div id="sumTotalleft">
                        <h6 style="color: #5f6264;margin-left: 5%">Sub Total :</h6>
                        <h6 style="color: #5f6264;margin-left: 5%">Promo Code :</h6>
                        <h6 style="color: #5f6264;margin-left: 5%">Special Offer :</h6>
                        <h5 style="color: #010201;font-weight: bold;margin-left: 5%">Total :</h5>

                    </div>
                    <div id="sumtotalright" class="ui-body ui-body-d">
                        <h6 id="prodSumTotal" style="color: #5f6264;text-align: right">LKR 2299.00</h6>
                        <a id="prodPromoCode" href="#promopop" onclick="" data-rel="popup" data-transition="pop"><h6 style="color: #7285ff;text-align: right">Enter code here</h6></a>
                        <a id="ProdSpecialOff" href="#offeropop" onclick="" data-rel="popup" data-transition="pop"><h6 style="color: #7285ff;text-align: right">Enter code here</h6></a>

                        </a>
                        <h5 id="prodSumAmount" style="color: #010201;font-weight: bold;text-align: right">LKR 2299.00
                        </h5>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div data-role="footer" data-position="fixed" role="banner">
        <div>
            <div style='float:left;width:70%' class="ui-body ui-body-d">

                <h6 style="color: #010201;font-weight: bold">Total</h6>
                <h4 id="PayAmount" style="color: #010201;font-weight: bold">2299.00</h4>

            </div>
            <div style='float:right;width:30%; height: 73.19px; text-align: center'>
                <button style="justify-content: center;" id="btPayNow" class="ui-btn ui-btn-inline">Pay Now</button>
            </div>
        </div>

    </div>




    <div style="margin-top: 20%;align-content: center;" class="ui-block-d" data-role="popup" id="popupBasic"
        data-overlay-theme="a" data-theme="a" data-dismissible="false" data-position-to="window"
        style="max-width:400px;" align="center">
        <div data-role="header" data-theme="b">
            <h1>Edit Address</h1>
        </div>
        <p>This address will be used for shipping this product.</p>
        <label for="popupBasic">Street:</label>
        <input type="text" name="name" id="streetInput" value="">
        <label for="popupBasic">City :</label>
        <input type="text" name="name" id="cityInput" value="">
        <label for="popupBasic">Province:</label>
        <input type="text" name="name" id="provinceInput" value="">
        <label for="popupBasic">Zip Code:</label>
        <input type="text" name="name" id="zipCodeInput" value="">

        <a href="" data-role="button" data-inline="true" data-rel="back">Cancel</a>
        <a id="saveAddress" onclick="SaveAddress()" data-role="button" data-theme="b" data-inline="true">Save</a>

    </div>

    <div id="popuppayment" style="margin-top: 20%;align-content: center;" data-role="popup" data-dialog="true" class="ui-block-d" data-transition="pop" data-overlay-theme="a"
         data-theme="a" data-dismissible="false" data-position-to="window" style="max-width:400px;">

        <div data-role="header" data-theme="b">
            <h1>Successful</h1>
        </div>

        <div role="main" class="ui-content">
            <!-- <h1>Delete page?</h1> -->
            <p style="text-align: center;">Your payment is successful. </br>Thank you !</p>
            <a href="" onclick="paymentSuccs()" class="ui-btn ui-shadow ui-corner-all ui-btn-b">OK</a>
        </div>
    </div>

    <div id="promopop" data-role="popup" data-dialog="true"  data-transition="pop" data-position-to="window">

        <div data-role="header" data-theme="b">
        </div>

        <label for="popupBasic">Promo code:</label>
    <input type="text" name="name" id="promoInput" value="">

    <a href="" data-role="button" data-inline="true" data-rel="back">Cancel</a>
    <a href="" onclick="promoCode()" data-role="button" data-theme="b" data-inline="true">OK</a>

    </div>

    <div id="offeropop" data-role="popup" data-dialog="true"  data-transition="pop" data-position-to="window">

        <div data-role="header" data-theme="b">
            <h1>Add Offer</h1>
        </div>
        <label for="popupBasic">offer code:</label>
        <input type="text" name="name" id="offerInput" value="">
        <div role="main" class="ui-content">
            <!-- <h1>Delete page?</h1> -->
            <a href="" data-role="button" data-inline="true" data-rel="back">Cancel</a>
            <a href="" onclick="offerCode()" data-role="button" data-theme="b" data-inline="true">OK</a>

        </div>
    </div>


    <div align="center" id="thankyouPayment">
        <script type="text/javascript">
            function SaveAddress() {

                let street = document.getElementById("streetInput").value;
                let city = document.getElementById("cityInput").value;
                let province = document.getElementById("provinceInput").value;
                let zip = document.getElementById("zipCodeInput").value;


                document.getElementById('custAddressRoad').innerHTML = street;
                document.getElementById('custAddressCity').innerHTML = city;
                document.getElementById('custAddressProvince').innerHTML = province;
                document.getElementById('custZipCode').innerHTML = zip;

                console.log(street);
                $("#popupBasic").popup('close');

            }

            function GotoAR() {
                // window.open("popups/PaymentPopup.html",'_self');
                location.href = "popups/PaymentPopup.html";
                //$("#popuppayment").popup("open");

            }
            $(document).ready(function () {
                let product_id = window.sessionStorage.getItem('product_id');
                console.log("Current product id is " + product_id);
                if (product_id != null) {
                    let msgText = 'Custom Loader';
                    let textVisible = 'true';
                    let theme = 'a';
                    let textonly = 'true';
                    let html = "<span class=\"ui-bar ui-shadow ui-overlay-d ui-corner-all\"><img alt='Loading' src=\"../lib/images/loader-logo-blue.png\"><h1 class='loaderText'>Loading ...</h1></span>";

                    $.mobile.loading("show", {
                        text: msgText,
                        textVisible: textVisible,
                        theme: theme,
                        textonly: textonly,
                        html: html
                    });
                    var millisecondsToWait = 2000;
                    setTimeout(function () {
                        // Whatever you want to do after the wait
                        $.ajax({
                            url: "http://localhost:9002/KLANmart/product/" + product_id
                        }).then(function (data) {
                            console.log(data);
                            if (data.status === "success") {
                                let prod_data = data.result[0];
                                let totalAmount = prod_data.price + 100;

                                console.log(prod_data.product_name);
                                document.getElementById("prodPrice").innerHTML = "LKR " + prod_data.price + ".00";
                                document.getElementById("productCategory").innerHTML = prod_data.product_name;
                                document.getElementById("prodName").innerHTML = prod_data.description;
                                document.getElementById("calProdPrice").innerHTML = "LKR " + prod_data.price + ".00";
                                document.getElementById("calProdTotal").innerHTML = "LKR " + totalAmount + ".00";

                                document.getElementById("prodSumTotal").innerHTML = "LKR " + totalAmount + ".00";
                                document.getElementById("prodSumAmount").innerHTML = "LKR " + totalAmount + ".00";
                                document.getElementById("PayAmount").innerHTML = totalAmount + ".00";

                            }
                        });
                        $.mobile.loading('hide');
                    }, millisecondsToWait);

                }
            });


            jQuery(function ($) {
                var $form = $('#frmBooking');
                var handler = StripeCheckout.configure({
                    key: 'pk_test_cp21BcECf4kMMUbSlRlZlsMo',
                    token: function (token) {
                        if (token.id) {
                            // $('#allContent').addClass('ui-disabled');

                            $("#popuppayment").popup("open");

                            let payAmount = document.getElementById('PayAmount').textContent;
                            let jsonData = { "Item": { "user_id": 2, "product_id": 1, "total_amount": payAmount, "order_time": "2019-10-11 10:45:14", "order_status": "paid", "quantity": 1, "store_id": 2}};
                            $(document).ready(function () {
                                $("button").click(function () {

                                    let xhttp = new XMLHttpRequest();
                                    xhttp.onreadystatechange = function() {
                                        if (this.readyState == 4 && this.status == 200) {
                                            alert(this.responseText);
                                        }
                                    };
                                    xhttp.open("POST", "http://localhost:9002/KLANmart/buy", true);
                                    xhttp.setRequestHeader("Content-type", "application/json");
                                    xhttp.send(JSON.stringify(jsonData));
                                });
                            });


                        }
                    }
                })



                $('#btPayNow').on('click', function (e) {
                    let payAmount = document.getElementById('PayAmount').textContent;
                    console.log("amount" + payAmount);
                    handler.open({
                        name: 'Enter Payment',
                        currency: 'LKR',
                        description: payAmount,
                        amount: payAmount * 100
                    }, '_self');


                });
            });

            popupbeforeposition: function hide() {
                $('.ui-popup-screen').off();
            }

            function promoCode() {
                let promo = document.getElementById("promoInput").value;
                let payAmount = document.getElementById('PayAmount').textContent;

                if(promo !=null && promo !=""){
                    payAmount = payAmount-100;
                    document.getElementById('prodPromoCode').innerHTML = "100 Off";
                    document.getElementById("prodSumAmount").innerHTML = "LKR "+payAmount+".00";
                    document.getElementById("PayAmount").innerHTML = payAmount;
                    $("#promopop").popup('close');
                    console.log(promo);
                    $('#prodPromoCode').href = "javascript:void(0)";
                    $('#prodPromoCode').color = "gray";


                }else {
                    $("#promopop").popup('close');
                }

            }

            function offerCode() {
                let offer = document.getElementById("offerInput").value;
                let payAmount = document.getElementById('PayAmount').textContent;

                if(offer !=null && offer !=""){
                    payAmount = payAmount*90/100;
                    document.getElementById('ProdSpecialOff').innerHTML = "10% Off";
                    document.getElementById("prodSumAmount").innerHTML = "LKR "+payAmount;
                    document.getElementById("PayAmount").innerHTML = payAmount;
                    $("#offeropop").popup('close');
                    console.log(offer);
                    $('#ProdSpecialOff').href = "javascript:void(0)";
                    $('#ProdSpecialOff').color = "gray";


                }else {
                    $("#offeropop").popup('close');
                }

            }

            function paymentSuccs() {
                window.location.href = "home.html";

            }




            $("#editAddress").on({
                popupbeforeposition: function () {
                    $('.ui-popup-screen').off();
                }
            });





            window.onload = function () {
                var loggedUser = sessionStorage.getItem("logged_user");

                var myJson = JSON.parse(loggedUser);
                console.log(myJson);

                if (loggedUser != null) {

                    document.getElementById('custName').innerHTML = myJson.f_name + "  " + myJson.l_name;
                    document.getElementById('custAddressRoad').innerHTML = myJson.address;
                    document.getElementById('custMobileNumber').innerHTML = myJson.mobile_no;
                    // document.getElementById('streetInput').innerHTML = myJson.address;
                    $('#streetInput').val(myJson.address);

                    let city = document.getElementById('custAddressCity').value;
                    let province = document.getElementById('custAddressProvince').value;
                    let zip = document.getElementById('custZipCode').value;

                    $('#cityInput').val(city);
                    $('#provinceInput').val(province);
                    $('#zipCodeInput').val(zip);





                    //                document.getElementById("logged").style.display = "none";
                    //                document.getElementById("if_logged").style.display = "block";
                    //
                    //
                    //                var myJson = JSON.parse(loggedUser);
                    //                console.log(myJson);
                    //                document.getElementById('custAddressRoad').innerHTML = myJson.f_name + "  " + myJson.l_name;
                    //                document.getElementById('mobile').innerHTML = myJson.mobile_no;
                    //                document.getElementById('pref_currency').innerHTML = myJson.pref_currency;
                    //            } else {
                    //                document.getElementById("if_logged").style.display = "none";
                    //                document.getElementById("logged").style.display = "block";

                }
            }

        </script>
    </div>
</body>

</html>